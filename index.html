<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Historial de Apuestas - Completo</title>
  <style>
    body{font-family:Arial, sans-serif;margin:18px;background:#f7f7f8;color:#222}
    h1,h2,h3{margin:6px 0}
    .grid{display:grid;grid-template-columns:1fr 420px;gap:16px}
    .box{background:#fff;padding:12px;border-radius:8px;border:1px solid #e1e1e1}
    label{display:block;margin:6px 0;font-size:14px}
    input,select,button{padding:6px;margin-top:4px;font-size:14px}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{border:1px solid #ddd;padding:6px;text-align:left;font-size:13px}
    th{background:#f1f1f1}
    .small{width:110px}
    .muted{color:#666;font-size:13px}
    .actions button{margin-right:6px}
    ul{padding-left:18px}
    .flex{display:flex;gap:8px;align-items:center}
    .full{width:100%}
    .chart-wrap{height:260px}
    .badge{background:#eee;padding:2px 6px;border-radius:6px;font-size:12px}
  </style>
</head>

<body>
  <h1>Mi Historial de Apuestas (Completo)</h1>
  <p class="muted">Registro de apuestas individuales y parlays ‚Äî editar, eliminar, estad√≠sticas y gr√°ficas.</p>

  <div class="grid">
    <div>
      <div class="box">
        <h2>Agregar / Editar Apuesta Individual</h2>
        <form id="individualForm">
          <input type="hidden" id="ind_id" />
          <label>Fecha: <input type="date" id="ind_date" required></label>
          <label>Deporte: <input type="text" id="ind_sport" placeholder="NBA, NFL..." required></label>
          <label>Tipo de apuesta:
            <select id="ind_betTarget">
              <option value="jugador">Jugador</option>
              <option value="equipo">Equipo</option>
            </select>
          </label>

          <label>Nombre: <input type="text" id="ind_team" placeholder="Nombre del jugador o equipo" required></label>

          <label>Cat√°logo:
            <select id="ind_type">
              <option value="ML">MoneyLine (ML)</option>
              <option value="SPREAD">Spread</option>
              <option value="TOTALES">Totales</option>
              <option value="ALT">Alternativa (ALT)</option>
            </select>
          </label>

          <div id="ind_stats_section" style="display:none;">
            <label>Estad√≠stica del jugador:
              <select id="ind_statCategory">
                <option value="puntos">Puntos</option>
                <option value="rebotes">Rebotes</option>
                <option value="asistencias">Asistencias</option>
                <option value="puntos_asistencias">Puntos + Asistencias</option>
                <option value="puntos_rebotes">Puntos + Rebotes</option>
                <option value="rebotes_asistencias">Rebotes + Asistencias</option>
                <option value="puntos_rebotes_asistencias">Puntos + Rebotes + Asistencias</option>
                <option value="triples">Triples anotados</option>
              </select>
            </label>
            <label>L√≠nea del jugador: <input type="number" step="0.5" id="ind_statLine"></label>
          </div>

          <label>Momio (odds): <input type="number" id="ind_odds" required></label>
          <label>Monto: <input type="number" id="ind_amount" required></label>

          <label>Resultado:
            <select id="ind_result">
              <option value="GANADA">GANADA</option>
              <option value="PERDIDA">PERDIDA</option>
            </select>
          </label>

          <div id="ind_winnings_section" style="display:none;">
            <label>üí∞ Ganancia obtenida: <input type="number" step="0.01" id="ind_winnings" placeholder="Cu√°nto ganaste"></label>
          </div>

          <div class="flex">
            <button type="submit">Guardar Individual</button>
            <button type="button" id="ind_cancel">Cancelar</button>
          </div>
        </form>
      </div>

      <div class="box" style="margin-top:12px">
        <h2>Crear / Editar Parley</h2>
        <form id="parleyForm">
          <input type="hidden" id="par_id" />
          <label>Fecha: <input type="date" id="par_date" required></label>
          <label>Monto total del parley: <input type="number" id="par_amount" required></label>

          <h3>A√±adir pick al parley</h3>
          <label>Deporte: <input type="text" id="pick_sport" placeholder="NBA" ></label>
          
          <label>Tipo de apuesta:
            <select id="pick_betTarget">
              <option value="jugador">Jugador</option>
              <option value="equipo">Equipo</option>
            </select>
          </label>

          <label>Nombre: <input type="text" id="pick_team" placeholder="Nombre del jugador o equipo"></label>

          <label>Cat√°logo:
            <select id="pick_type">
              <option value="ML">MoneyLine (ML)</option>
              <option value="SPREAD">Spread</option>
              <option value="TOTALES">Totales</option>
              <option value="ALT">Alternativa (ALT)</option>
            </select>
          </label>

          <div id="pick_stats_section" style="display:none;">
            <label>Estad√≠stica del jugador:
              <select id="pick_statCategory">
                <option value="puntos">Puntos</option>
                <option value="rebotes">Rebotes</option>
                <option value="asistencias">Asistencias</option>
                <option value="puntos_asistencias">Puntos + Asistencias</option>
                <option value="puntos_rebotes">Puntos + Rebotes</option>
                <option value="rebotes_asistencias">Rebotes + Asistencias</option>
                <option value="puntos_rebotes_asistencias">Puntos + Rebotes + Asistencias</option>
                <option value="triples">Triples anotados</option>
              </select>
            </label>
            <label>L√≠nea del pick: <input type="number" step="0.5" id="pick_statLine"></label>
          </div>
          <label>Momio: <input type="number" id="pick_odds"></label>
          <label>Resultado:
            <select id="pick_result">
              <option value="GANADA">GANADA</option>
              <option value="PERDIDA">PERDIDA</option>
            </select>
          </label>
          <div class="flex" style="margin-top:8px">
            <button type="button" id="add_pick">Agregar pick</button>
            <button type="button" id="clear_picks">Limpiar picks</button>
          </div>

          <h4>Picks a√±adidos (<span id="pick_count">0</span>):</h4>
          <ul id="picks_list"></ul>

          <label>Resultado final del Parley:
            <select id="par_result">
              <option value="GANADA">GANADA</option>
              <option value="PERDIDA">PERDIDA</option>
            </select>
          </label>

          <div id="par_winnings_section" style="display:none;">
            <label>üí∞ Ganancia obtenida: <input type="number" step="0.01" id="par_winnings" placeholder="Cu√°nto ganaste"></label>
          </div>

          <div class="flex" style="margin-top:8px">
            <button type="submit">Guardar Parley</button>
            <button type="button" id="par_cancel">Cancelar</button>
          </div>
        </form>
      </div>

    </div>

    <div>
      <div class="box">
        <h2>Dashboard</h2>
        <p class="muted">Resumen r√°pido</p>
        <p>üìÖ <b>D√≠a con mejor rendimiento:</b> <span id="best-day">-</span></p>
        <p>üèÜ <b>Deporte con m√°s aciertos:</b> <span id="best-sport">-</span></p>

        <h3>Buscar cu√°ntas veces inclu√≠ una apuesta individual (tambi√©n en parlays)</h3>
        <label>Equipo/Jugador: <input id="search_team" placeholder="Nombre"></label>
        <label>Tipo de apuesta: <input id="search_type" placeholder="ML, ALT..."></label>
        <button id="search_btn">Buscar</button>
        <p id="search_output"></p>
        <div id="search_results" style="margin-top:12px;display:none;">
          <h4>Apuestas encontradas:</h4>
          <table style="width:100%;border-collapse:collapse;margin-top:8px;font-size:12px;">
            <thead>
              <tr>
                <th style="border:1px solid #ddd;padding:4px;background:#f1f1f1;">Fecha</th>
                <th style="border:1px solid #ddd;padding:4px;background:#f1f1f1;">Tipo</th>
                <th style="border:1px solid #ddd;padding:4px;background:#f1f1f1;">Detalle</th>
                <th style="border:1px solid #ddd;padding:4px;background:#f1f1f1;">Monto</th>
                <th style="border:1px solid #ddd;padding:4px;background:#f1f1f1;">Resultado</th>
              </tr>
            </thead>
            <tbody id="search_results_body"></tbody>
          </table>
        </div>
      </div>

      <div class="box" style="margin-top:12px">
        <h3>Gr√°fica: Efectividad por Jugador/Equipo</h3>
        <div class="chart-wrap"><canvas id="playersChart"></canvas></div>
      </div>

      <div class="box" style="margin-top:12px">
        <h3>Parley - Distribuci√≥n de p√©rdidas (perdieron por N picks)</h3>
        <table>
          <thead><tr><th>Fallos en el parley</th><th>Conteo</th></tr></thead>
          <tbody id="parley-fail-table"></tbody>
        </table>
      </div>

      <div class="box" style="margin-top:12px">
        <h3>üí∞ Ganancias/P√©rdidas por Mes</h3>
        <table id="monthly_table">
          <thead><tr><th>Mes</th><th>Ganadas</th><th>Perdidas</th><th>Balance</th><th>ROI</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <div style="margin-top:14px" class="box">
    <h2>Historial Completo (Individuales y Parleys)</h2>
    <table id="bets_table_full">
      <thead>
        <tr>
          <th>Fecha</th>
          <th>Tipo</th>
          <th>Detalle</th>
          <th>Monto</th>
          <th>Resultado</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div style="margin-top:12px" class="box">
    <h3>Rendimiento por Deporte (picks acertados / total)</h3>
    <table id="sport_performance">
      <thead><tr><th>Deporte</th><th>Aciertos</th><th>Total</th><th>Ratio</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // --- Helpers ---
    function uid() { return Math.random().toString(36).slice(2,9); }
    function getBets(){return JSON.parse(localStorage.getItem('bets'))||[]}
    function saveBets(b){localStorage.setItem('bets',JSON.stringify(b))}

    // --- State for building parley ---
    let tempPicks = [];
    let editingParleyId = null;
    let editingIndividualId = null;

    // --- DOM refs ---
    const picksList = document.getElementById('picks_list');
    const pickCount = document.getElementById('pick_count');

    // --- Init ---
    document.addEventListener('DOMContentLoaded', ()=>{
      bindForms();
      renderAll();
    });

    function bindForms(){
      // Individual form
      const indForm = document.getElementById('individualForm');
      indForm.addEventListener('submit', e=>{
        e.preventDefault();
        saveIndividual();
      });
      document.getElementById('ind_cancel').addEventListener('click',()=>resetIndividualForm());

      // Toggle stats section for individual bets based on bet target
      const indBetTarget = document.getElementById('ind_betTarget');
      const indStatsSection = document.getElementById('ind_stats_section');
      indBetTarget.addEventListener('change', ()=>{
        if(indBetTarget.value === 'equipo'){
          indStatsSection.style.display = 'none';
        } else {
          indStatsSection.style.display = 'block';
        }
      });

      // Toggle winnings section for individual bets
      const indResult = document.getElementById('ind_result');
      const indWinningsSection = document.getElementById('ind_winnings_section');
      indResult.addEventListener('change', ()=>{
        if(indResult.value === 'GANADA'){
          indWinningsSection.style.display = 'block';
        } else {
          indWinningsSection.style.display = 'none';
        }
      });

      // Parley form
      document.getElementById('add_pick').addEventListener('click', addPick);
      document.getElementById('clear_picks').addEventListener('click', ()=>{tempPicks=[];renderPicks();});
      document.getElementById('parleyForm').addEventListener('submit', e=>{e.preventDefault();saveParley();});
      document.getElementById('par_cancel').addEventListener('click', ()=>{tempPicks=[];renderPicks();resetParleyForm();});

      // Toggle stats section for picks based on bet target
      const pickBetTarget = document.getElementById('pick_betTarget');
      const pickStatsSection = document.getElementById('pick_stats_section');
      pickBetTarget.addEventListener('change', ()=>{
        if(pickBetTarget.value === 'equipo'){
          pickStatsSection.style.display = 'none';
        } else {
          pickStatsSection.style.display = 'block';
        }
      });

      // Toggle winnings section for parley
      const parResult = document.getElementById('par_result');
      const parWinningsSection = document.getElementById('par_winnings_section');
      parResult.addEventListener('change', ()=>{
        if(parResult.value === 'GANADA'){
          parWinningsSection.style.display = 'block';
        } else {
          parWinningsSection.style.display = 'none';
        }
      });

      // Search
      document.getElementById('search_btn').addEventListener('click', ()=>{
        const team = document.getElementById('search_team').value.trim();
        const type = document.getElementById('search_type').value.trim();
        const results = findAppearances(team,type);
        document.getElementById('search_output').textContent = `Apareci√≥ ${results.count} veces (incluyendo picks dentro de parlays).`;
        renderSearchResults(results.bets);
      });
    }

    // --- Individual logic ---
    function saveIndividual(){
      const id = document.getElementById('ind_id').value || uid();
      const betTarget = document.getElementById('ind_betTarget').value;
      const result = document.getElementById('ind_result').value;
      const bet = {
        id, type:'individual',
        date: document.getElementById('ind_date').value,
        sport: document.getElementById('ind_sport').value.trim(),
        betTarget: betTarget,
        team: document.getElementById('ind_team').value.trim(),
        bet_type: document.getElementById('ind_type').value,
        statCategory: betTarget === 'jugador' ? document.getElementById('ind_statCategory').value : null,
        statLine: betTarget === 'jugador' ? Number(document.getElementById('ind_statLine').value) : null,
        odds: Number(document.getElementById('ind_odds').value),
        amount: Number(document.getElementById('ind_amount').value),
        result: result,
        winnings: result === 'GANADA' ? (Number(document.getElementById('ind_winnings').value) || 0) : 0
      };
      const bets = getBets();
      const existing = bets.findIndex(b=>b.id===id);
      if(existing>=0){bets[existing]=bet;} else {bets.push(bet);}      
      saveBets(bets);
      resetIndividualForm();
      renderAll();
    }

    function resetIndividualForm(){
      document.getElementById('ind_id').value='';
      document.getElementById('ind_date').value='';
      document.getElementById('ind_sport').value='';
      document.getElementById('ind_betTarget').value='jugador';
      document.getElementById('ind_team').value='';
      document.getElementById('ind_type').value='ML';
      document.getElementById('ind_statCategory').value='puntos';
      document.getElementById('ind_statLine').value='';
      document.getElementById('ind_odds').value='';
      document.getElementById('ind_amount').value='';
      document.getElementById('ind_result').value='GANADA';
      document.getElementById('ind_winnings').value='';
      document.getElementById('ind_stats_section').style.display = 'none';
      document.getElementById('ind_winnings_section').style.display = 'none';
    }

    function editIndividual(id){
      const bets = getBets();
      const b = bets.find(x=>x.id===id);
      if(!b) return;
      document.getElementById('ind_id').value=b.id;
      document.getElementById('ind_date').value=b.date;
      document.getElementById('ind_sport').value=b.sport;
      document.getElementById('ind_betTarget').value=b.betTarget||'jugador';
      document.getElementById('ind_team').value=b.team;
      document.getElementById('ind_type').value=b.bet_type||'ML';
      document.getElementById('ind_statCategory').value=b.statCategory||'puntos';
      document.getElementById('ind_statLine').value=b.statLine||'';
      document.getElementById('ind_odds').value=b.odds||'';
      document.getElementById('ind_amount').value=b.amount||'';
      document.getElementById('ind_result').value=b.result||'GANADA';
      document.getElementById('ind_winnings').value=b.winnings||'';
      
      // Check if stats section should be visible
      if(b.betTarget === 'equipo'){
        document.getElementById('ind_stats_section').style.display = 'none';
      } else {
        document.getElementById('ind_stats_section').style.display = 'block';
      }

      // Check if winnings section should be visible
      if(b.result === 'GANADA'){
        document.getElementById('ind_winnings_section').style.display = 'block';
      } else {
        document.getElementById('ind_winnings_section').style.display = 'none';
      }
      
      window.scrollTo(0,0);
    }

    // --- Parley logic ---
    function addPick(){
      const betTarget = document.getElementById('pick_betTarget').value;
      const pick = {
        id: uid(),
        sport: document.getElementById('pick_sport').value.trim(),
        betTarget: betTarget,
        team: document.getElementById('pick_team').value.trim(),
        bet_type: document.getElementById('pick_type').value,
        statCategory: betTarget === 'jugador' ? document.getElementById('pick_statCategory').value : null,
        statLine: betTarget === 'jugador' ? (Number(document.getElementById('pick_statLine').value)||null) : null,
        odds: Number(document.getElementById('pick_odds').value)||null,
        result: document.getElementById('pick_result').value
      };
      if(!pick.team || !pick.sport) { alert('Falta deporte o nombre'); return; }
      tempPicks.push(pick);
      renderPicks();
      clearPickInputs();
    }

    function clearPickInputs(){
      document.getElementById('pick_sport').value='';
      document.getElementById('pick_betTarget').value='jugador';
      document.getElementById('pick_team').value='';
      document.getElementById('pick_type').value='ML';
      document.getElementById('pick_statCategory').value='puntos';
      document.getElementById('pick_statLine').value='';
      document.getElementById('pick_odds').value='';
      document.getElementById('pick_result').value='GANADA';
      document.getElementById('pick_stats_section').style.display = 'none';
    }

    function renderPicks(){
      picksList.innerHTML='';
      tempPicks.forEach((p,i)=>{
        const li = document.createElement('li');
        const statsInfo = p.betTarget === 'jugador' && p.statCategory ? `[${p.statCategory} ${p.statLine||''}]` : '';
        li.innerHTML = `${p.sport} - ${p.team} (${p.betTarget}) ${p.bet_type} ${statsInfo} - ${p.result} <span class="muted">odds:${p.odds||'-'}</span> <span class="actions"><button onclick="editPick('${p.id}')">Editar</button><button onclick="removePick('${p.id}')">Eliminar</button></span>`;
        picksList.appendChild(li);
      });
      pickCount.textContent = tempPicks.length;
    }

    function editPick(id){
      const p = tempPicks.find(x=>x.id===id);
      if(!p) return;
      document.getElementById('pick_sport').value=p.sport;
      document.getElementById('pick_betTarget').value=p.betTarget||'jugador';
      document.getElementById('pick_team').value=p.team;
      document.getElementById('pick_type').value=p.bet_type||'ML';
      document.getElementById('pick_statCategory').value=p.statCategory||'puntos';
      document.getElementById('pick_statLine').value=p.statLine||'';
      document.getElementById('pick_odds').value=p.odds||'';
      document.getElementById('pick_result').value=p.result||'GANADA';
      
      // Check if stats section should be visible
      if(p.betTarget === 'equipo'){
        document.getElementById('pick_stats_section').style.display = 'none';
      } else {
        document.getElementById('pick_stats_section').style.display = 'block';
      }
      
      // remove original so saving acts as update
      tempPicks = tempPicks.filter(x=>x.id!==id);
      renderPicks();
    }

    function removePick(id){ tempPicks = tempPicks.filter(x=>x.id!==id); renderPicks(); }

    function saveParley(){
      const id = document.getElementById('par_id').value || uid();
      if(tempPicks.length===0){ alert('Agrega al menos un pick al parley'); return; }
      const result = document.getElementById('par_result').value;
      const par = {
        id, type:'parley', date:document.getElementById('par_date').value,
        amount: Number(document.getElementById('par_amount').value)||0,
        picks: tempPicks.slice(),
        result: result,
        winnings: result === 'GANADA' ? (Number(document.getElementById('par_winnings').value) || 0) : 0
      };
      const bets = getBets();
      const idx = bets.findIndex(b=>b.id===id);
      if(idx>=0) bets[idx]=par; else bets.push(par);
      saveBets(bets);
      tempPicks=[]; renderPicks(); resetParleyForm(); renderAll();
    }

    function resetParleyForm(){
      document.getElementById('par_id').value='';
      document.getElementById('par_date').value='';
      document.getElementById('par_amount').value='';
      document.getElementById('par_result').value='GANADA';
      document.getElementById('par_winnings').value='';
      document.getElementById('par_winnings_section').style.display = 'none';
    }

    function editParley(id){
      const bets = getBets(); const p = bets.find(b=>b.id===id && b.type==='parley');
      if(!p) return; editingParleyId = id; tempPicks = p.picks.map(x=>Object.assign({},x)); renderPicks();
      document.getElementById('par_id').value=p.id; 
      document.getElementById('par_date').value=p.date; 
      document.getElementById('par_amount').value=p.amount; 
      document.getElementById('par_result').value=p.result;
      document.getElementById('par_winnings').value=p.winnings||'';

      // Check if winnings section should be visible
      if(p.result === 'GANADA'){
        document.getElementById('par_winnings_section').style.display = 'block';
      } else {
        document.getElementById('par_winnings_section').style.display = 'none';
      }
      
      window.scrollTo(0,0);
    }

    // --- Delete functions ---
    function deleteBet(id){ if(!confirm('Eliminar esta apuesta?')) return; const bets = getBets().filter(b=>b.id!==id); saveBets(bets); renderAll(); }

    // --- Count appearances including inside parleys ---
    function countAppearances(team,type){
      const bets = getBets(); let cnt=0;
      bets.forEach(b=>{
        if(b.type==='individual'){
          if(b.team===team && b.bet_type===type) cnt++;
        } else if(b.type==='parley'){
          b.picks.forEach(p=>{ if(p.team===team && p.bet_type===type) cnt++; });
        }
      });
      return cnt;
    }

    // --- Find appearances and return bets with matching picks ---
    function findAppearances(team,type){
      const bets = getBets();
      const foundBets = [];
      let count = 0;
      
      bets.forEach(b=>{
        if(b.type==='individual'){
          if(b.team===team && b.bet_type===type){
            count++;
            foundBets.push(b);
          }
        } else if(b.type==='parley'){
          // Check if any pick matches
          const matchingPicks = b.picks.filter(p=> p.team===team && p.bet_type===type);
          if(matchingPicks.length > 0){
            count += matchingPicks.length;
            // Include the full parley bet so we can show all its details
            foundBets.push(b);
          }
        }
      });
      
      return {count, bets: foundBets};
    }

    // --- Render search results ---
    function renderSearchResults(bets){
      const resultsDiv = document.getElementById('search_results');
      const tbody = document.getElementById('search_results_body');
      
      if(bets.length === 0){
        resultsDiv.style.display = 'none';
        return;
      }
      
      resultsDiv.style.display = 'block';
      tbody.innerHTML = '';
      
      bets.forEach(b=>{
        const tr = document.createElement('tr');
        let detail = '';
        if(b.type==='individual'){
          const statsInfo = b.betTarget === 'jugador' && b.statCategory ? `[${b.statCategory} ${b.statLine||''}]` : '';
          detail = `${b.team} (${b.betTarget}) ${b.bet_type} ${statsInfo} odds:${b.odds}`;
        } else {
          detail = b.picks.map(p=>{
            const statsInfo = p.betTarget === 'jugador' && p.statCategory ? `[${p.statCategory} ${p.statLine||''}]` : '';
            return `${p.sport}-${p.team} (${p.betTarget}) ${p.bet_type} ${statsInfo} odds:${p.odds||'-'}`;
          }).join('<br>');
        }
        tr.innerHTML = `
          <td style="border:1px solid #ddd;padding:4px;">${b.date||'-'}</td>
          <td style="border:1px solid #ddd;padding:4px;">${b.type}</td>
          <td style="border:1px solid #ddd;padding:4px;">${detail}</td>
          <td style="border:1px solid #ddd;padding:4px;">${b.amount||'-'}</td>
          <td style="border:1px solid #ddd;padding:4px;">${b.result||'-'}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // --- Rendering full table ---
    function renderAll(){ renderFullTable(); updateDashboard(); renderSportPerformance(); renderPlayersChart(); renderParleyFailTable(); renderMonthlyTable(); }

    function renderFullTable(){
      const tbody = document.querySelector('#bets_table_full tbody'); tbody.innerHTML='';
      const bets = getBets();
      bets.forEach(b=>{
        const tr = document.createElement('tr');
        let detail = '';
        if(b.type==='individual'){
          const statsInfo = b.betTarget === 'jugador' && b.statCategory ? `[${b.statCategory} ${b.statLine||''}]` : '';
          detail = `${b.team} (${b.betTarget}) ${b.bet_type} ${statsInfo} odds:${b.odds}`;
        } else {
          detail = b.picks.map(p=>{
            const statsInfo = p.betTarget === 'jugador' && p.statCategory ? `[${p.statCategory} ${p.statLine||''}]` : '';
            return `${p.sport}-${p.team} (${p.betTarget}) ${p.bet_type} ${statsInfo} odds:${p.odds||'-'}`;
          }).join('<br>');
        }
        tr.innerHTML = `<td>${b.date||'-'}</td><td>${b.type}</td><td>${detail}</td><td>${b.amount||'-'}</td><td>${b.result||'-'}</td><td class="actions"></td>`;
        tbody.appendChild(tr);
        const actions = tr.querySelector('.actions');
        if(b.type==='individual'){
          const ed = document.createElement('button'); ed.textContent='Editar'; ed.onclick = ()=>editIndividual(b.id);
          const del = document.createElement('button'); del.textContent='Eliminar'; del.onclick = ()=>deleteBet(b.id);
          actions.appendChild(ed); actions.appendChild(del);
        } else {
          const ed = document.createElement('button'); ed.textContent='Editar Parley'; ed.onclick = ()=>editParley(b.id);
          const del = document.createElement('button'); del.textContent='Eliminar'; del.onclick = ()=>deleteBet(b.id);
          actions.appendChild(ed); actions.appendChild(del);
        }
      });
    }

    // --- Dashboard computations ---
    function updateDashboard(){
      document.getElementById('best-day').textContent = computeBestDay();
      document.getElementById('best-sport').textContent = computeBestSport();
      document.getElementById('search_output').textContent = '';
    }

    function computeBestDay(){
      const bets = getBets(); const winsByDay = {};
      bets.forEach(b=>{
        if(b.type==='individual'){
          if(b.result==='GANADA'){
            const d = new Date(b.date).toLocaleDateString('es-MX',{weekday:'long'});
            winsByDay[d]=(winsByDay[d]||0)+1;
          }
        } else {
          // count each pick within parley
          b.picks.forEach(p=>{ if(p.result==='GANADA'){ const d=new Date(b.date).toLocaleDateString('es-MX',{weekday:'long'}); winsByDay[d]=(winsByDay[d]||0)+1; } });
        }
      });
      let best='-'; let max=0; for(const k in winsByDay) if(winsByDay[k]>max){max=winsByDay[k];best=k;} return best;
    }

    function computeBestSport(){
      const bets = getBets(); const map = {};
      bets.forEach(b=>{
        if(b.type==='individual'){ if(b.result==='GANADA'){ map[b.sport]=(map[b.sport]||0)+1; } }
        else { b.picks.forEach(p=>{ if(p.result==='GANADA'){ map[p.sport]=(map[p.sport]||0)+1; } }); }
      });
      let best='-'; let max=0; for(const k in map) if(map[k]>max){max=map[k];best=k;} return best;
    }

    // --- Sport performance table ---
    function renderSportPerformance(){
      const bets = getBets(); const stats = {}; // sport -> {wins,total}
      bets.forEach(b=>{
        if(b.type==='individual'){
          stats[b.sport]=stats[b.sport]||{wins:0,total:0}; stats[b.sport].total++; if(b.result==='GANADA') stats[b.sport].wins++;
        } else {
          b.picks.forEach(p=>{ stats[p.sport]=stats[p.sport]||{wins:0,total:0}; stats[p.sport].total++; if(p.result==='GANADA') stats[p.sport].wins++; });
        }
      });
      const tbody = document.querySelector('#sport_performance tbody'); tbody.innerHTML='';
      for(const s in stats){ const r = stats[s]; const tr = document.createElement('tr'); tr.innerHTML=`<td>${s}</td><td>${r.wins}</td><td>${r.total}</td><td>${(r.wins/r.total*100).toFixed(1)}%</td>`; tbody.appendChild(tr);}    
    }

    // --- Players chart (effectiveness) ---
    let playersChart=null;
    function renderPlayersChart(){
      const bets = getBets(); const map = {}; // team-> {wins,total}
      bets.forEach(b=>{
        if(b.type==='individual'){
          map[b.team]=map[b.team]||{wins:0,total:0}; map[b.team].total++; if(b.result==='GANADA') map[b.team].wins++;
        } else {
          b.picks.forEach(p=>{ map[p.team]=map[p.team]||{wins:0,total:0}; map[p.team].total++; if(p.result==='GANADA') map[p.team].wins++; });
        }
      });
      // sort top 12 by total
      const entries = Object.entries(map).sort((a,b)=>b[1].total-a[1].total).slice(0,12);
      const labels = entries.map(e=>e[0]);
      const wins = entries.map(e=>e[1].wins);
      const losses = entries.map(e=>e[1].total - e[1].wins);

      const ctx = document.getElementById('playersChart').getContext('2d');
      if(playersChart) playersChart.destroy();
      playersChart = new Chart(ctx,{
        type:'bar', data:{labels, datasets:[{label:'Ganadas',data:wins,backgroundColor:'#4caf50'},{label:'Perdidas',data:losses,backgroundColor:'#f44336'}]},
        options:{responsive:true,maintainAspectRatio:true, scales:{x:{stacked:true}, y:{stacked:true, beginAtZero:true}}}
      });
    }

    // --- Parley fail breakdown ---
    function renderParleyFailTable(){
      const bets = getBets(); const counts = {1:0,2:0,3:0,4:0,'5+':0};
      bets.forEach(b=>{
        if(b.type==='parley'){
          const total = b.picks.length; const failed = b.picks.filter(p=>p.result!=='GANADA').length; if(failed===0) return; if(failed>=5) counts['5+']++; else counts[failed]++;
        }
      });
      const tbody = document.getElementById('parley-fail-table'); tbody.innerHTML='';
      Object.keys(counts).forEach(k=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${k}</td><td>${counts[k]}</td>`; tbody.appendChild(tr); });
    }

    // --- Monthly profit/loss table ---
    function renderMonthlyTable(){
      const bets = getBets();
      const monthly = {}; // 'YYYY-MM' -> {invested, returned}
      
      bets.forEach(b=>{
        if(!b.date || !b.amount) return;
        const month = b.date.substring(0,7); // Extract YYYY-MM
        if(!monthly[month]) monthly[month] = {invested:0, returned:0};
        
        monthly[month].invested += b.amount;
        
        if(b.result === 'GANADA'){
          // Si hay winnings registrados manualmente, usarlos; si no, calcular basado en odds
          if(b.winnings && b.winnings > 0){
            // Usar el valor de winnings registrado manualmente
            monthly[month].returned += b.amount + b.winnings;
          } else {
            // Calcular basado en odds (comportamiento anterior)
            if(b.type === 'individual'){
              // Return = amount + (amount * odds)
              const profit = b.amount * (b.odds || 0);
              monthly[month].returned += b.amount + profit;
            } else if(b.type === 'parley'){
              // For parley, calculate combined odds
              let combinedOdds = 1;
              b.picks.forEach(p=>{
                if(p.odds) combinedOdds *= (p.odds > 0 ? (p.odds/100 + 1) : (1 + 100/Math.abs(p.odds)));
              });
              const profit = b.amount * (combinedOdds - 1);
              monthly[month].returned += b.amount + profit;
            }
          }
        }
        // If PERDIDA, returned stays 0 for that bet
      });

      const tbody = document.querySelector('#monthly_table tbody');
      tbody.innerHTML = '';
      
      // Sort months descending
      const months = Object.keys(monthly).sort().reverse();
      
      months.forEach(m=>{
        const data = monthly[m];
        const balance = data.returned - data.invested;
        const roi = data.invested > 0 ? ((balance / data.invested) * 100).toFixed(1) : '0.0';
        const balanceColor = balance >= 0 ? 'green' : 'red';
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${m}</td>
          <td style="color:green">${data.returned.toFixed(2)}</td>
          <td style="color:red">${data.invested.toFixed(2)}</td>
          <td style="color:${balanceColor}"><b>${balance.toFixed(2)}</b></td>
          <td style="color:${balanceColor}">${roi}%</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // --- Expose some functions to window for inline onclick used in created elements ---
    window.editPick = editPick; window.removePick = removePick; window.editParley = editParley; window.editIndividual = editIndividual; window.deleteBet = deleteBet;

  </script>
</body>
</html>
